# Audio Data Processing for Bird Species Detection and Analysis

## Project Purpose

This project provides a suite of Python scripts designed to process audio recordings to:
1.  Detect bird species using the BirdNET analysis tool.
2.  Enrich these detections with taxonomic information (Norwegian common names, scientific names for species, family, and order) by querying the Artskart Public API.
3.  Save the enriched detection data to a CSV file.
4.  Split the original audio files into smaller segments based on the detections, organizing them into folders named after the detected species (using Norwegian common names). A maximum of 10 segments are saved per species.

## Directory Structure

-   `analyser_lyd_main.py`: The main script to execute the entire processing pipeline.
-   `data_input_lyd/`: This directory should contain the input audio files (e.g., WAV format) that you want to analyze.
-   `data_output_lyd/`: This directory stores the output generated by the scripts.
    -   `interim/enriched_detections.csv`: A CSV file containing all bird detections enriched with taxonomic data.
    -   `lydfiler/`: This directory will contain subdirectories for each detected bird species (named with Norwegian common names). Each species folder will hold the extracted audio segments (.wav files) for that species.
-   `functions/`: Contains modular Python scripts for different parts of the processing:
    -   `birdnetlib_api.py`: Handles the interaction with the BirdNET library for audio analysis.
    -   `artskart_api.py`: Manages API calls to Artskart to fetch taxonomic information.
    -   `splitter_lydfilen.py`: Contains the logic for splitting audio files based on detections.
-   `databehandling_lyd_project_info.md`: This README file.

## Setup and Installation

This project uses Python and several external libraries. It is recommended to use `uv` for environment and package management.

1.  **Create and Activate a Virtual Environment (Recommended):**
    Open your terminal in the root of the `artsdata` project directory (i.e., one level above `databehandling_lyd`) and run:
    ```bash
    uv venv
    source .venv/bin/activate  # On macOS/Linux
    # .venv\\Scripts\\activate    # On Windows
    ```

2.  **Install Dependencies:**
    The following Python packages are required. You can install them using `uv`:
    ```bash
    uv pip install pandas birdnetlib requests tqdm pydub
    ```
    *   `pandas`: For data manipulation and creating DataFrames.
    *   `birdnetlib`: The core library for bird sound analysis. (This may install other dependencies like TensorFlow Lite).
    *   `requests`: For making HTTP requests to the Artskart API.
    *   `tqdm`: For displaying progress bars during lengthy operations.
    *   `pydub`: For audio manipulation (splitting files).

3.  **FFmpeg (System Dependency for pydub):**
    `pydub` requires FFmpeg to be installed on your system to work with various audio formats (including WAV for splitting). If you don't have FFmpeg installed, you'll need to install it separately.
    *   **macOS (using Homebrew):** `brew install ffmpeg`
    *   **Linux (using apt):** `sudo apt update && sudo apt install ffmpeg`
    *   **Windows:** Download from the [FFmpeg website](https://ffmpeg.org/download.html) and add it to your system's PATH.

## Running the Analysis

To run the full analysis pipeline:

1.  Ensure your virtual environment is activated.
2.  Place your audio files into the `databehandling_lyd/data_input_lyd/` directory.
3.  Navigate to the `databehandling_lyd` directory in your terminal:
    ```bash
    cd path/to/your/project/artsdata/databehandling_lyd
    ```
4.  Run the main script:
    ```bash
    python analyser_lyd_main.py
    ```

The script will:
-   Log its progress to the console.
-   Process audio files from `data_input_lyd/`.
-   Fetch taxonomic data.
-   Save the `enriched_detections.csv` file.
-   Create split audio segments in `data_output_lyd/lydfiler/`.

## Configuration Notes

-   **Input Directory:** Audio files must be placed in `databehandling_lyd/data_input_lyd/`.
-   **Output Directories:** Outputs are saved to `databehandling_lyd/data_output_lyd/interim/` and `databehandling_lyd/data_output_lyd/lydfiler/`. These are currently hardcoded in `analyser_lyd_main.py`.
-   **BirdNET Confidence:** The minimum confidence threshold for BirdNET detections is set within `functions/birdnetlib_api.py` (currently `min_conf=0.5`).
-   **API Endpoints:** The Artskart API endpoint is defined in `functions/artskart_api.py`.
-   **Max Segments per Species:** The audio splitting is capped at 10 segments per species, defined in `functions/splitter_lydfilen.py`.

## Outputs

1.  **Enriched Detections CSV:**
    -   File: `databehandling_lyd/data_output_lyd/interim/enriched_detections.csv`
    -   Description: A semicolon-separated CSV file containing detailed information for each bird sound detection. Columns include scientific names, common names (English and Norwegian for species, family, order), start/end times of detection, confidence scores, and file paths.

2.  **Split Audio Segments:**
    -   Location: `databehandling_lyd/data_output_lyd/lydfiler/`
    -   Description: This directory contains subfolders for each detected species (named with the Norwegian common name, e.g., "r√∏dvingetrost"). Inside each species folder, you'll find the individual audio segments (.wav files) corresponding to the detections for that species. The filenames include the original audio filename, start/end times, and the species name.
